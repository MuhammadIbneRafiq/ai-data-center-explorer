import Papa from "papaparse";

export interface DatacenterLocation {
  country: string;
  countryCode: string;
  totalDatacenters: number;
  hyperscaleDatacenters: number;
  colocationDatacenters: number;
  floorSpaceSqft: string;
  powerCapacityMW: string;
  renewableEnergyUsage: string;
  keyOperators: string;
  cloudProviders: string;
  internetPenetration: string;
  coolingTechnologies: string;
  regulatoryChallenges: string;
  greenInitiatives: string;
}

// Map country names to ISO 2-letter codes for flag API
const countryToCode: Record<string, string> = {
  "United States": "US",
  "Germany": "DE",
  "United Kingdom": "GB",
  "China": "CN",
  "France": "FR",
  "Canada": "CA",
  "Australia": "AU",
  "Netherlands": "NL",
  "Russia": "RU",
  "Japan": "JP",
  "Brazil": "BR",
  "Singapore": "SG",
  "South Africa": "ZA",
  "India": "IN",
  "Mexico": "MX",
  "Sweden": "SE",
  "Indonesia": "ID",
  "Spain": "ES",
  "Poland": "PL",
  "Switzerland": "CH",
  "Afghanistan": "AF",
  "Albania": "AL",
  "Algeria": "DZ",
  "Andorra": "AD",
  "Angola": "AO",
  "Antigua and Barbuda": "AG",
  "Argentina": "AR",
  "Armenia": "AM",
  "Austria": "AT",
  "Azerbaijan": "AZ",
  "Bahamas": "BS",
  "Bahrain": "BH",
  "Bangladesh": "BD",
  "Barbados": "BB",
  "Belarus": "BY",
  "Belgium": "BE",
  "Belize": "BZ",
  "Benin": "BJ",
  "Bhutan": "BT",
  "Bolivia": "BO",
  "Bosnia and Herzegovina": "BA",
  "Botswana": "BW",
  "Brunei": "BN",
  "Bulgaria": "BG",
  "Burkina Faso": "BF",
  "Burundi": "BI",
  "Cambodia": "KH",
  "Cameroon": "CM",
  "Cape Verde": "CV",
  "Central African Republic": "CF",
  "Chad": "TD",
  "Chile": "CL",
  "Colombia": "CO",
  "Comoros": "KM",
  "Congo": "CG",
  "Costa Rica": "CR",
  "Croatia": "HR",
  "Cuba": "CU",
  "Cyprus": "CY",
  "Czech Republic": "CZ",
  "Denmark": "DK",
  "Djibouti": "DJ",
  "Dominica": "DM",
  "Dominican Republic": "DO",
  "Ecuador": "EC",
  "Egypt": "EG",
  "El Salvador": "SV",
  "Equatorial Guinea": "GQ",
  "Eritrea": "ER",
  "Estonia": "EE",
  "Eswatini": "SZ",
  "Ethiopia": "ET",
  "Fiji": "FJ",
  "Finland": "FI",
  "Gabon": "GA",
  "Gambia": "GM",
  "Georgia": "GE",
  "Ghana": "GH",
  "Greece": "GR",
  "Grenada": "GD",
  "Guatemala": "GT",
  "Guinea": "GN",
  "Guinea-Bissau": "GW",
  "Guyana": "GY",
  "Haiti": "HT",
  "Honduras": "HN",
  "Hong Kong": "HK",
  "Hungary": "HU",
  "Iceland": "IS",
  "Iran": "IR",
  "Iraq": "IQ",
  "Ireland": "IE",
  "Israel": "IL",
  "Italy": "IT",
  "Ivory Coast": "CI",
  "Jamaica": "JM",
  "Jordan": "JO",
  "Kazakhstan": "KZ",
  "Kenya": "KE",
  "Kiribati": "KI",
  "Kuwait": "KW",
  "Kyrgyzstan": "KG",
  "Laos": "LA",
  "Latvia": "LV",
  "Lebanon": "LB",
  "Lesotho": "LS",
  "Liberia": "LR",
  "Libya": "LY",
  "Liechtenstein": "LI",
  "Lithuania": "LT",
  "Luxembourg": "LU",
  "Madagascar": "MG",
  "Malawi": "MW",
  "Malaysia": "MY",
  "Maldives": "MV",
  "Mali": "ML",
  "Malta": "MT",
  "Marshall Islands": "MH",
  "Mauritania": "MR",
  "Mauritius": "MU",
  "Micronesia": "FM",
  "Moldova": "MD",
  "Monaco": "MC",
  "Mongolia": "MN",
  "Montenegro": "ME",
  "Morocco": "MA",
  "Mozambique": "MZ",
  "Myanmar": "MM",
  "Namibia": "NA",
  "Nauru": "NR",
  "Nepal": "NP",
  "New Zealand": "NZ",
  "Nicaragua": "NI",
  "Niger": "NE",
  "Nigeria": "NG",
  "North Korea": "KP",
  "North Macedonia": "MK",
  "Norway": "NO",
  "Oman": "OM",
  "Pakistan": "PK",
  "Palau": "PW",
  "Palestine": "PS",
  "Panama": "PA",
  "Papua New Guinea": "PG",
  "Paraguay": "PY",
  "Peru": "PE",
  "Philippines": "PH",
  "Portugal": "PT",
  "Qatar": "QA",
  "Romania": "RO",
  "Rwanda": "RW",
  "Saint Kitts and Nevis": "KN",
  "Saint Lucia": "LC",
  "Saint Vincent and the Grenadines": "VC",
  "Samoa": "WS",
  "San Marino": "SM",
  "Sao Tome and Principe": "ST",
  "Saudi Arabia": "SA",
  "Senegal": "SN",
  "Serbia": "RS",
  "Seychelles": "SC",
  "Sierra Leone": "SL",
  "Slovakia": "SK",
  "Slovenia": "SI",
  "Solomon Islands": "SB",
  "Somalia": "SO",
  "South Korea": "KR",
  "South Sudan": "SS",
  "Sri Lanka": "LK",
  "Sudan": "SD",
  "Suriname": "SR",
  "Syria": "SY",
  "Taiwan": "TW",
  "Tajikistan": "TJ",
  "Tanzania": "TZ",
  "Thailand": "TH",
  "Timor-Leste": "TL",
  "Togo": "TG",
  "Tonga": "TO",
  "Trinidad and Tobago": "TT",
  "Tunisia": "TN",
  "Turkey": "TR",
  "Turkmenistan": "TM",
  "Tuvalu": "TV",
  "Uganda": "UG",
  "Ukraine": "UA",
  "United Arab Emirates": "AE",
  "Uruguay": "UY",
  "Uzbekistan": "UZ",
  "Vanuatu": "VU",
  "Vatican City": "VA",
  "Venezuela": "VE",
  "Vietnam": "VN",
  "Yemen": "YE",
  "Zambia": "ZM",
  "Zimbabwe": "ZW",
  "Kosovo": "XK",
  "Puerto Rico": "PR",
  "Réunion": "RE",
  "New Caledonia": "NC",
  "French Polynesia": "PF",
  "Guam": "GU",
  "Martinique": "MQ",
  "Guadeloupe": "GP",
  "Isle of Man": "IM",
  "Jersey": "JE",
  "Guernsey": "GG",
  "Gibraltar": "GI",
  "Greenland": "GL",
  "Faroe Islands": "FO",
  "Bermuda": "BM",
  "Cayman Islands": "KY",
  "British Virgin Islands": "VG",
  "U.S. Virgin Islands": "VI",
  "Aruba": "AW",
  "Curaçao": "CW",
  "Sint Maarten": "SX",
};

// Approximate coordinates for countries
const countryCoordinates: Record<string, [number, number]> = {
  "US": [37.0902, -95.7129],
  "DE": [51.1657, 10.4515],
  "GB": [55.3781, -3.4360],
  "CN": [35.8617, 104.1954],
  "FR": [46.6034, 1.8883],
  "CA": [56.1304, -106.3468],
  "AU": [-25.2744, 133.7751],
  "NL": [52.1326, 5.2913],
  "RU": [61.5240, 105.3188],
  "JP": [36.2048, 138.2529],
  "BR": [-14.2350, -51.9253],
  "SG": [1.3521, 103.8198],
  "ZA": [-30.5595, 22.9375],
  "IN": [20.5937, 78.9629],
  "MX": [23.6345, -102.5528],
  "SE": [60.1282, 18.6435],
  "ID": [-0.7893, 113.9213],
  "ES": [40.4637, -3.7492],
  "PL": [51.9194, 19.1451],
  "CH": [46.8182, 8.2275],
  "AF": [33.9391, 67.7100],
  "AL": [41.1533, 20.1683],
  "DZ": [28.0339, 1.6596],
  "AD": [42.5063, 1.5218],
  "AO": [-11.2027, 17.8739],
  "AG": [17.0608, -61.7964],
  "AR": [-38.4161, -63.6167],
  "AM": [40.0691, 45.0382],
  "AT": [47.5162, 14.5501],
  "AZ": [40.1431, 47.5769],
  "BS": [25.0343, -77.3963],
  "BH": [26.0667, 50.5577],
  "BD": [23.6850, 90.3563],
  "BB": [13.1939, -59.5432],
  "BY": [53.7098, 27.9534],
  "BE": [50.5039, 4.4699],
  "BZ": [17.1899, -88.4976],
  "BJ": [9.3077, 2.3158],
  "BT": [27.5142, 90.4336],
  "BO": [-16.2902, -63.5887],
  "BA": [43.9159, 17.6791],
  "BW": [-22.3285, 24.6849],
  "BN": [4.5353, 114.7277],
  "BG": [42.7339, 25.4858],
  "BF": [12.2383, -1.5616],
  "BI": [-3.3731, 29.9189],
  "KH": [12.5657, 104.9910],
  "CM": [7.3697, 12.3547],
  "CV": [16.5388, -23.0418],
  "CF": [6.6111, 20.9394],
  "TD": [15.4542, 18.7322],
  "CL": [-35.6751, -71.5430],
  "CO": [4.5709, -74.2973],
  "KM": [-11.6455, 43.3333],
  "CG": [-0.2280, 15.8277],
  "CR": [9.7489, -83.7534],
  "HR": [45.1000, 15.2000],
  "CU": [21.5218, -77.7812],
  "CY": [35.1264, 33.4299],
  "CZ": [49.8175, 15.4730],
  "DK": [56.2639, 9.5018],
  "DJ": [11.8251, 42.5903],
  "DM": [15.4150, -61.3710],
  "DO": [18.7357, -70.1627],
  "EC": [-1.8312, -78.1834],
  "EG": [26.8206, 30.8025],
  "SV": [13.7942, -88.8965],
  "GQ": [1.6508, 10.2679],
  "ER": [15.1794, 39.7823],
  "EE": [58.5953, 25.0136],
  "SZ": [-26.5225, 31.4659],
  "ET": [9.1450, 40.4897],
  "FJ": [-17.7134, 178.0650],
  "FI": [61.9241, 25.7482],
  "GA": [-0.8037, 11.6094],
  "GM": [13.4432, -15.3101],
  "GE": [42.3154, 43.3569],
  "GH": [7.9465, -1.0232],
  "GR": [39.0742, 21.8243],
  "GD": [12.1165, -61.6790],
  "GT": [15.7835, -90.2308],
  "GN": [9.9456, -9.6966],
  "GW": [11.8037, -15.1804],
  "GY": [4.8604, -58.9302],
  "HT": [18.9712, -72.2852],
  "HN": [15.2000, -86.2419],
  "HK": [22.3193, 114.1694],
  "HU": [47.1625, 19.5033],
  "IS": [64.9631, -19.0208],
  "IR": [32.4279, 53.6880],
  "IQ": [33.2232, 43.6793],
  "IE": [53.1424, -7.6921],
  "IL": [31.0461, 34.8516],
  "IT": [41.8719, 12.5674],
  "CI": [7.5400, -5.5471],
  "JM": [18.1096, -77.2975],
  "JO": [30.5852, 36.2384],
  "KZ": [48.0196, 66.9237],
  "KE": [-0.0236, 37.9062],
  "KI": [-3.3704, -168.7340],
  "KW": [29.3117, 47.4818],
  "KG": [41.2044, 74.7661],
  "LA": [19.8563, 102.4955],
  "LV": [56.8796, 24.6032],
  "LB": [33.8547, 35.8623],
  "LS": [-29.6100, 28.2336],
  "LR": [6.4281, -9.4295],
  "LY": [26.3351, 17.2283],
  "LI": [47.1660, 9.5554],
  "LT": [55.1694, 23.8813],
  "LU": [49.8153, 6.1296],
  "MG": [-18.7669, 46.8691],
  "MW": [-13.2543, 34.3015],
  "MY": [4.2105, 101.9758],
  "MV": [3.2028, 73.2207],
  "ML": [17.5707, -3.9962],
  "MT": [35.9375, 14.3754],
  "MH": [7.1315, 171.1845],
  "MR": [21.0079, -10.9408],
  "MU": [-20.3484, 57.5522],
  "FM": [7.4256, 150.5508],
  "MD": [47.4116, 28.3699],
  "MC": [43.7384, 7.4246],
  "MN": [46.8625, 103.8467],
  "ME": [42.7087, 19.3744],
  "MA": [31.7917, -7.0926],
  "MZ": [-18.6657, 35.5296],
  "MM": [21.9162, 95.9560],
  "NA": [-22.9576, 18.4904],
  "NR": [-0.5228, 166.9315],
  "NP": [28.3949, 84.1240],
  "NZ": [-40.9006, 174.8860],
  "NI": [12.8654, -85.2072],
  "NE": [17.6078, 8.0817],
  "NG": [9.0820, 8.6753],
  "KP": [40.3399, 127.5101],
  "MK": [41.5124, 21.7453],
  "NO": [60.4720, 8.4689],
  "OM": [21.4735, 55.9754],
  "PK": [30.3753, 69.3451],
  "PW": [7.5150, 134.5825],
  "PS": [31.9522, 35.2332],
  "PA": [8.5380, -80.7821],
  "PG": [-6.3150, 143.9555],
  "PY": [-23.4425, -58.4438],
  "PE": [-9.1900, -75.0152],
  "PH": [12.8797, 121.7740],
  "PT": [39.3999, -8.2245],
  "QA": [25.3548, 51.1839],
  "RO": [45.9432, 24.9668],
  "RW": [-1.9403, 29.8739],
  "KN": [17.3578, -62.7830],
  "LC": [13.9094, -60.9789],
  "VC": [12.9843, -61.2872],
  "WS": [-13.7590, -172.1046],
  "SM": [43.9424, 12.4578],
  "ST": [0.1864, 6.6131],
  "SA": [23.8859, 45.0792],
  "SN": [14.4974, -14.4524],
  "RS": [44.0165, 21.0059],
  "SC": [-4.6796, 55.4920],
  "SL": [8.4606, -11.7799],
  "SK": [48.6690, 19.6990],
  "SI": [46.1512, 14.9955],
  "SB": [-9.6457, 160.1562],
  "SO": [5.1521, 46.1996],
  "KR": [35.9078, 127.7669],
  "SS": [6.8770, 31.3070],
  "LK": [7.8731, 80.7718],
  "SD": [12.8628, 30.2176],
  "SR": [3.9193, -56.0278],
  "SY": [34.8021, 38.9968],
  "TW": [23.6978, 120.9605],
  "TJ": [38.8610, 71.2761],
  "TZ": [-6.3690, 34.8888],
  "TH": [15.8700, 100.9925],
  "TL": [-8.8742, 125.7275],
  "TG": [8.6195, 0.8248],
  "TO": [-21.1789, -175.1982],
  "TT": [10.6918, -61.2225],
  "TN": [33.8869, 9.5375],
  "TR": [38.9637, 35.2433],
  "TM": [38.9697, 59.5563],
  "TV": [-7.1095, 179.1940],
  "UG": [1.3733, 32.2903],
  "UA": [48.3794, 31.1656],
  "AE": [23.4241, 53.8478],
  "UY": [-32.5228, -55.7658],
  "UZ": [41.3775, 64.5853],
  "VU": [-15.3767, 166.9592],
  "VA": [41.9029, 12.4534],
  "VE": [6.4238, -66.5897],
  "VN": [14.0583, 108.2772],
  "YE": [15.5527, 48.5164],
  "ZM": [-13.1339, 27.8493],
  "ZW": [-19.0154, 29.1549],
  "XK": [42.6026, 20.9030],
  "PR": [18.2208, -66.5901],
};

function parseNumber(value: string): number {
  if (!value) return 0;
  // Remove special characters and parse
  const cleaned = value.replace(/[~,+%$]/g, '').trim();
  const num = parseInt(cleaned, 10);
  return isNaN(num) ? 0 : num;
}

export async function loadDatacenterLocations(): Promise<DatacenterLocation[]> {
  const response = await fetch("/datacenter_location.csv");
  const csvText = await response.text();

  return new Promise((resolve, reject) => {
    Papa.parse(csvText, {
      header: true,
      skipEmptyLines: true,
      complete: (results) => {
        const locations: DatacenterLocation[] = results.data
          .map((row: any) => {
            const countryName = row.country?.trim();
            if (!countryName) return null;
            
            const code = countryToCode[countryName] || "";
            const totalDC = parseNumber(row.total_data_centers);
            
            // Skip countries with 0 datacenters
            if (totalDC === 0) return null;

            return {
              country: countryName,
              countryCode: code,
              totalDatacenters: totalDC,
              hyperscaleDatacenters: parseNumber(row.hyperscale_data_centers),
              colocationDatacenters: parseNumber(row.colocation_data_centers),
              floorSpaceSqft: row.floor_space_sqft_total || "",
              powerCapacityMW: row.power_capacity_MW_total || "",
              renewableEnergyUsage: row.average_renewable_energy_usage_percent || "",
              keyOperators: row.key_operators || "",
              cloudProviders: row.cloud_provider || "",
              internetPenetration: row.internet_penetration_percent || "",
              coolingTechnologies: row.cooling_technologies_common || "",
              regulatoryChallenges: row.regulatory_challenges_or_limits || "",
              greenInitiatives: row.green_dc_initiatives_description || "",
            };
          })
          .filter((loc): loc is DatacenterLocation => loc !== null);

        resolve(locations);
      },
      error: (error) => {
        reject(error);
      },
    });
  });
}

export function getCountryCoords(countryCode: string): [number, number] | null {
  return countryCoordinates[countryCode] || null;
}

export function getFlagUrl(countryCode: string): string {
  // Using flagcdn.com for circular flag icons
  return `https://flagcdn.com/w80/${countryCode.toLowerCase()}.png`;
}
